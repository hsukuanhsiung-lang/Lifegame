<!DOCTYPE html>
<!-- saved from url=(0057)file:///C:/Users/Administrator/Downloads/lifegame-v7.html -->
<html lang="zh-CN"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>äººç”Ÿæ¸¸æˆ</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&family=Share+Tech+Mono&display=swap');
:root{
  --bg:#0a0a0f;--bg2:#0f0f1a;--bg3:#16162a;--bg4:#1c1c32;
  --border:#ffffff20;--border2:#ffffff30;
  --text:#e8e8f0;--text2:#8888a8;--text3:#555570;
  --or:#ff8c42;--ord:#ff8c4230;
  --re:#ff4466;--red:#ff446630;
  --bl:#4a9eff;--bld:#4a9eff30;
  --gr:#3ddc84;--grd:#3ddc8430;
  --ye:#ffd060;--yed:#ffd06030;
  --gy:#7777bb;--gyd:#7777bb30;
  --nav:62px;--safe:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans SC',sans-serif;display:flex;flex-direction:column}
.mono{font-family:'Share Tech Mono',monospace}
/* HEADER */
.hdr{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:10px 16px 8px;border-bottom:1px solid var(--border);background:var(--bg)}
.hdr-title{font-size:18px;font-weight:900;letter-spacing:3px;background:linear-gradient(90deg,var(--ye),var(--or));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hdr-right{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.day-badge{font-size:11px;padding:3px 10px;border-radius:20px;background:var(--yed);color:var(--ye);font-weight:700;border:1px solid var(--ye)}
.hdr-date{font-size:10px;color:var(--text2)}
/* ATTR STRIP */
.astrip{flex-shrink:0;display:flex;border-bottom:1px solid var(--border);background:var(--bg2);overflow-x:auto;scrollbar-width:none}
.astrip::-webkit-scrollbar{display:none}
.achip{flex:1;min-width:58px;display:flex;flex-direction:column;align-items:center;padding:6px 4px;gap:2px;border-right:1px solid var(--border)}
.achip:last-child{border-right:none}
.achip .v{font-size:14px;font-weight:700;font-family:'Share Tech Mono',monospace}
.achip .l{font-size:8px;color:var(--text2);font-weight:700;letter-spacing:1px}
/* PAGES */
.pages{flex:1;min-height:0;position:relative;overflow:hidden}
.page{position:absolute;inset:0;overflow-y:auto;display:none;padding-bottom:calc(var(--nav) + var(--safe) + 4px)}
.page.active{display:block}
#pAI{padding-bottom:0}
#pAI.active{display:flex;flex-direction:column}
/* NAV */
.nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav) + var(--safe));padding-bottom:var(--safe);background:var(--bg);border-top:1px solid var(--border);display:flex;z-index:999}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;background:none;border:none;cursor:pointer;font-family:inherit;color:var(--text2);transition:color .15s}
.nb.on{color:var(--ye)}
.nb .ic{font-size:21px;line-height:1}
.nb .lb{font-size:9px;font-weight:700;letter-spacing:.3px}
/* HELPERS */
.sh{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 6px}
.sh-t{font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text2);text-transform:uppercase}
.sh-a{font-size:12px;color:var(--ye);background:none;border:none;font-family:inherit;cursor:pointer;font-weight:700}
.empty{text-align:center;padding:36px 20px;color:var(--text2)}
.empty .ei{font-size:34px;margin-bottom:10px}
.empty p{font-size:13px;line-height:1.6}
/* â•â• AI â•â• */
.ai-msgs{flex:1;min-height:0;overflow-y:auto;padding:12px 14px;display:flex;flex-direction:column;gap:10px}
.ai-msgs .spacer{height:8px;flex-shrink:0}
.msg{max-width:88%;display:flex;flex-direction:column;gap:3px}
.msg.u{align-self:flex-end;align-items:flex-end}
.msg.a{align-self:flex-start;align-items:flex-start}
.bubble{padding:11px 14px;border-radius:16px;font-size:14px;line-height:1.65;white-space:pre-wrap;word-break:break-word}
.msg.u .bubble{background:var(--ye);color:#0a0a0f;border-bottom-right-radius:4px}
.msg.a .bubble{background:var(--bg3);color:var(--text);border:1px solid var(--border2);border-bottom-left-radius:4px}
.msg-t{font-size:10px;color:var(--text2)}
.ai-foot{flex-shrink:0;background:var(--bg);border-top:1px solid var(--border);padding-bottom:calc(var(--nav) + var(--safe))}
.qrow{display:flex;gap:6px;padding:8px 12px 4px;overflow-x:auto;scrollbar-width:none}
.qrow::-webkit-scrollbar{display:none}
.qchip{flex-shrink:0;padding:7px 13px;border-radius:20px;font-size:12px;font-weight:700;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);cursor:pointer;white-space:nowrap;font-family:inherit;transition:all .1s}
.qchip:active{background:var(--yed);border-color:var(--ye);color:var(--ye)}
.irow{display:flex;gap:8px;padding:6px 12px 8px;align-items:flex-end}
.ainput{flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:22px;color:var(--text);font-family:inherit;font-size:14px;padding:10px 16px;outline:none;resize:none;max-height:120px;line-height:1.5}
.ainput:focus{border-color:var(--border2)}
.asend{background:var(--ye);color:#0a0a0f;border:none;width:42px;height:42px;border-radius:50%;font-size:20px;font-weight:900;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.dots span{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--text2);animation:blink 1.2s infinite;margin:0 2px}
.dots span:nth-child(2){animation-delay:.2s}
.dots span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
/* â•â• TIME â•â• */
.vtabs{display:flex;gap:6px;padding:10px 14px 6px;overflow-x:auto;scrollbar-width:none}
.vtabs::-webkit-scrollbar{display:none}
.vtab{flex-shrink:0;padding:7px 16px;border-radius:20px;font-size:12px;font-weight:700;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s}
.vtab.on{background:var(--ye);color:#0a0a0f;border-color:var(--ye)}
/* Palette */
.palrow{display:flex;gap:5px;padding:8px 14px;overflow-x:auto;scrollbar-width:none;background:var(--bg2);border-bottom:1px solid var(--border)}
.palrow::-webkit-scrollbar{display:none}
.palitem{display:flex;flex-direction:column;align-items:center;gap:3px;padding:7px 9px;border-radius:10px;border:2px solid transparent;cursor:pointer;flex-shrink:0;background:var(--bg3);transition:border-color .15s}
.palitem.on{border-color:rgba(255,255,255,.8)}
.paldot{width:24px;height:24px;border-radius:7px}
.palitem span{font-size:10px;font-weight:700;color:var(--text);white-space:nowrap}
/* Sub behavior row */
.subrow{min-height:40px;display:flex;gap:6px;padding:6px 14px;overflow-x:auto;scrollbar-width:none;background:var(--bg2);border-bottom:1px solid var(--border);align-items:center}
.subrow::-webkit-scrollbar{display:none}
.subchip{flex-shrink:0;padding:5px 10px;border-radius:20px;font-size:12px;font-weight:700;border:2px solid transparent;cursor:pointer;font-family:inherit;white-space:nowrap;transition:all .15s;color:var(--text);background:var(--bg3);display:flex;align-items:center;gap:5px}
.subchip.on{color:#0a0a0f;border-color:rgba(0,0,0,.3)}
.sub-del{font-size:13px;color:rgba(0,0,0,0.5);cursor:pointer;line-height:1;display:none}
.subchip.on .sub-del{display:inline}
.sub-add-btn{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700;background:none;border:1px dashed var(--border2);color:var(--text2);cursor:pointer;font-family:inherit;white-space:nowrap}
/* Grid */
.gdate{display:flex;align-items:center;gap:8px;padding:8px 14px}
.gdbtn{background:var(--bg2);border:1px solid var(--border2);color:var(--text);width:32px;height:32px;border-radius:8px;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.gdlbl{flex:1;text-align:center;font-size:13px;font-weight:700}
.gdtoday{background:var(--yed);border:1px solid var(--ye);color:var(--ye);font-size:11px;font-weight:700;font-family:inherit;padding:6px 12px;border-radius:8px;cursor:pointer}
.gtbl{width:100%;border-collapse:collapse;border:2px solid var(--border2);border-radius:8px;overflow:hidden;table-layout:fixed}
.gtbl col.hcol{width:46px}
.gtbl col.qcol{width:calc((100% - 46px)/4)}
.gtbl tr{border-bottom:1px solid var(--border2)}
.gtbl tr:last-child{border-bottom:none}
.hlbl{width:46px;text-align:center;font-size:10px;font-weight:700;color:var(--text);background:var(--bg2);padding:0 4px;font-family:'Share Tech Mono',monospace;white-space:nowrap;border-right:2px solid var(--border2)}
.gcell{height:36px;cursor:pointer;border-right:1px solid var(--border2);background:var(--bg3);transition:opacity .1s;position:relative;overflow:hidden}
.gcell:last-child{border-right:none}
.gcell:active{opacity:.6}
.gcell-lbl{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:13px;color:rgba(255,255,255,0.98);font-weight:900;pointer-events:none;font-family:'Share Tech Mono',monospace;text-shadow:0 1px 4px rgba(0,0,0,.8);letter-spacing:.5px}
.gcell.c-or{background:var(--or)!important}
.gcell.c-re{background:var(--re)!important}
.gcell.c-bl{background:var(--bl)!important}
.gcell.c-gr{background:var(--gr)!important}
.gcell.c-ye{background:var(--ye)!important}
.gcell.c-gy{background:var(--gy)!important}
.collapse-row{display:flex;align-items:center;gap:8px;padding:7px 14px;cursor:pointer;background:var(--bg2);border-bottom:1px solid var(--border);user-select:none;-webkit-user-select:none}
.collapse-row:active{background:var(--bg3)}
.collapse-arrow{font-size:14px;color:var(--text2);transition:transform .25s;display:inline-block;font-weight:700}
.collapse-arrow.open{transform:rotate(90deg)}
.collapse-label{font-size:12px;font-weight:700;color:var(--text2);flex:1}
.collapse-info{font-size:11px;color:var(--text3);font-family:'Share Tech Mono',monospace}
/* Grid summary */
.gsum{padding:0 14px}
.gsrow{display:flex;align-items:center;gap:8px;padding:7px 0;border-bottom:1px solid var(--border)}
.gsrow:last-child{border-bottom:none}
.gsdot{width:12px;height:12px;border-radius:4px;flex-shrink:0}
.gsname{flex:1;font-size:13px;font-weight:600}
.gssubs{font-size:11px;color:var(--text2);margin-top:2px}
.gstime{font-size:12px;color:var(--text2);font-family:'Share Tech Mono',monospace}
.gsattr{font-size:12px;font-weight:700;font-family:'Share Tech Mono',monospace;min-width:56px;text-align:right}
/* Charts */
.period-tabs{display:flex;gap:5px;padding:8px 14px 4px;overflow-x:auto;scrollbar-width:none}
.period-tabs::-webkit-scrollbar{display:none}
.ptab{flex-shrink:0;padding:6px 14px;border-radius:20px;font-size:12px;font-weight:700;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s}
.ptab.on{background:var(--ye);color:#0a0a0f;border-color:var(--ye)}
.cnav{display:flex;align-items:center;gap:8px;padding:4px 14px 8px}
.cnbtn{background:var(--bg2);border:1px solid var(--border2);color:var(--text);width:32px;height:32px;border-radius:8px;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cnlbl{flex:1;text-align:center;font-size:13px;font-weight:600}
.cbox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;margin:0 14px 12px}
.ctitle{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--text2);text-transform:uppercase;margin-bottom:12px}
.brow{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.blbl{font-size:12px;font-weight:700;min-width:48px}
.btrack{flex:1;height:14px;background:var(--bg3);border-radius:7px;overflow:hidden}
.bfill{height:100%;border-radius:7px;transition:width .4s ease}
.bval{font-size:11px;color:var(--text2);min-width:36px;text-align:right;font-family:'Share Tech Mono',monospace}
.pie-wrap{display:flex;align-items:center;gap:14px}
.pie-leg{display:flex;flex-direction:column;gap:7px;flex:1}
.pie-item{display:flex;align-items:center;gap:7px}
.pie-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.pie-name{font-size:12px;font-weight:600;flex:1}
.pie-val{font-size:11px;color:var(--text2);font-family:'Share Tech Mono',monospace}
/* â•â• DAILY â•â• */
.scorecard{margin:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;align-items:center;gap:14px}
.dlist{padding:0 14px;display:flex;flex-direction:column;gap:6px}
.dcard{background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:10px;padding:12px 13px;cursor:pointer;transition:all .15s}
.dcard.done{border-color:var(--gr);background:var(--grd)}
.dcard.fail{border-color:var(--re);background:var(--red)}
.dchk{width:26px;height:26px;border-radius:8px;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;transition:all .15s;background:var(--bg3)}
.done .dchk{background:var(--gr);border-color:var(--gr);color:#0a0a0f}
.fail .dchk{background:var(--re);border-color:var(--re);color:#fff}
.dico{font-size:20px;flex-shrink:0}
.dinfo{flex:1}
.dname{font-size:14px;font-weight:600}
.dreq{font-size:11px;color:var(--text2);margin-top:2px}
.strk{font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;background:var(--ord);color:var(--or);border:1px solid var(--or)}
.flist{padding:0 14px;display:flex;flex-direction:column;gap:6px}
.fcard{background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:center;gap:10px;padding:11px 13px;cursor:pointer;transition:all .15s}
.fcard.kept{border-color:var(--gr);background:var(--grd)}
.fcard.broke{border-color:var(--re);background:var(--red)}
.fstat{font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px;font-family:'Share Tech Mono',monospace}
.kept .fstat{background:var(--grd);color:var(--gr)}
.broke .fstat{background:var(--red);color:var(--re)}
/* â•â• TASKS â•â• */
.tmtabs{display:flex;gap:6px;padding:10px 14px 4px;overflow-x:auto;scrollbar-width:none}
.tmtabs::-webkit-scrollbar{display:none}
.tmtab{flex-shrink:0;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;position:relative}
.tmtab.on{background:var(--ye);color:#0a0a0f;border-color:var(--ye)}
.badge{position:absolute;top:-4px;right:-4px;min-width:18px;height:18px;background:var(--re);color:#fff;border-radius:9px;font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid var(--bg);font-family:'Share Tech Mono',monospace}
.tstabs{display:flex;gap:6px;padding:2px 14px 8px;overflow-x:auto;scrollbar-width:none}
.tstabs::-webkit-scrollbar{display:none}
.tstab{flex-shrink:0;padding:5px 13px;border-radius:20px;font-size:11px;font-weight:700;background:var(--bg3);border:1px solid var(--border2);color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;position:relative}
.tstab.on{background:var(--bg4);border-color:var(--text2);color:var(--text)}
.tlist{padding:0 14px;display:flex;flex-direction:column;gap:7px}
.tcard{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:13px 14px;cursor:pointer;transition:all .15s}
.tcard.done{opacity:.55;border-color:var(--gr)}
.tcard.ov{border-color:var(--re)}
.ttop{display:flex;align-items:flex-start;gap:8px}
.tcb{width:22px;height:22px;border-radius:6px;border:2px solid var(--border2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .15s;background:var(--bg3);margin-top:1px}
.done .tcb{background:var(--gr);border-color:var(--gr);color:#0a0a0f}
.ttit{flex:1;font-size:14px;font-weight:700;line-height:1.4}
.done .ttit{text-decoration:line-through;color:var(--text2)}
.tbadge{font-size:9px;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:4px;flex-shrink:0;margin-top:2px}
.bm{background:var(--yed);color:var(--ye)}
.bs{background:var(--bld);color:var(--bl)}
.bb{background:var(--gyd);color:var(--text2)}
.bo{background:var(--red);color:var(--re)}
.tnote{font-size:12px;color:var(--text2);margin-top:6px;padding-left:30px;line-height:1.5}
.tmeta{display:flex;gap:8px;margin-top:6px;padding-left:30px;align-items:center;flex-wrap:wrap}
.tdue{font-size:11px;color:var(--text2);font-family:'Share Tech Mono',monospace}
.tbtn{font-size:11px;background:none;border:none;cursor:pointer;padding:0;font-family:inherit}
/* â•â• STATS â•â• */
.sgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:10px 14px 0}
.sbox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px}
.slbl{font-size:9px;font-weight:700;letter-spacing:2px;color:var(--text2);text-transform:uppercase;margin-bottom:6px}
.sval{font-size:26px;font-weight:900;font-family:'Share Tech Mono',monospace}
.sunit{font-size:12px;color:var(--text2)}
.hrow{display:flex;align-items:center;gap:8px;padding:9px 14px;border-bottom:1px solid var(--border);cursor:pointer}
.hdate{font-size:11px;color:var(--text2);min-width:44px;font-family:'Share Tech Mono',monospace}
.hbar{flex:1;height:10px;border-radius:5px;overflow:hidden;display:flex;gap:1px}
.hseg{height:100%}
.hchips{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.hchip{font-size:10px;font-family:'Share Tech Mono',monospace;padding:1px 6px;border-radius:3px;background:var(--bg3)}
/* MODAL */
.mbg{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:500;display:none;align-items:flex-end}
.mbg.show{display:flex}
.modal{background:var(--bg2);border-top:1px solid var(--border2);border-radius:20px 20px 0 0;padding:18px 16px 36px;width:100%;max-height:85vh;overflow-y:auto}
.mhdr{display:flex;align-items:center;margin-bottom:16px}
.mtit{flex:1;font-size:16px;font-weight:900}
.mclose{background:none;border:none;color:var(--text2);font-size:26px;cursor:pointer;line-height:1}
.fl{margin-bottom:12px}
.flab{font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;display:block}
.fi,.fs{width:100%;background:var(--bg3);border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:14px;padding:11px 13px;border-radius:10px;outline:none}
.fbtn{width:100%;background:var(--ye);color:#0a0a0f;border:none;font-family:inherit;font-size:15px;font-weight:700;padding:13px;border-radius:12px;cursor:pointer;margin-top:6px}
</style>
</head>
<body>
<div class="hdr">
  <div><div class="hdr-title">äººç”Ÿæ¸¸æˆ</div></div>
  <div class="hdr-right"><div class="day-badge" id="dayBadge">Day 1</div><div class="hdr-date" id="hdrDate">2æœˆ18æ—¥ æ˜ŸæœŸä¸‰</div></div>
</div>
<div class="astrip" id="astrip">
    <div class="achip"><span class="v" style="color:#ff8c42">0.00</span><span class="l">ç”Ÿå‘½</span></div>
    <div class="achip"><span class="v" style="color:#ff4466">0.00</span><span class="l">åŠ›é‡</span></div>
    <div class="achip"><span class="v" style="color:#4a9eff">0.00</span><span class="l">æ™ºåŠ›</span></div>
    <div class="achip"><span class="v" style="color:#3ddc84">0.00</span><span class="l">æ•æ·</span></div>
    <div class="achip"><span class="v" style="color:#ffd060">0.00</span><span class="l">è‡ªç”±ç‚¹</span></div></div>
<div class="pages">

<!-- AI -->
<div class="page active" id="pAI">
  <div class="ai-msgs" id="aiMsgs"><div class="msg a"><div class="bubble">ä½ å¥½ï¼ŒKuanã€‚ä»Šå¤© 2026-02-17ï¼ŒDay 1ã€‚

ç³»ç»Ÿå·²å°±ç»ªï¼Œå¯ç›´æ¥å‘Šè¯‰æˆ‘ä»Šå¤©åšäº†ä»€ä¹ˆï¼Œæˆ–ç‚¹ä¸Šæ–¹å¿«æ·é”®ã€‚</div><div class="msg-t">01:03</div></div><div class="spacer"></div></div>
  <div class="ai-foot">
    <div class="qrow" id="qrow"><button class="qchip">ğŸ“Š ä»Šæ—¥å±æ€§</button><button class="qchip">ğŸ“‹ æ¯æ—¥è¿›åº¦</button><button class="qchip">ğŸš© ä»Šæ—¥ä»»åŠ¡</button><button class="qchip">ğŸ“ è®°å¿†è¡¥ä¸</button></div>
    <div class="irow">
      <textarea class="ainput" id="ainput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œæˆ–ç‚¹ä¸Šæ–¹å¿«æ·é”®â€¦" rows="1" oninput="aResize(this)" onkeydown="aKey(event)"></textarea>
      <button class="asend" onclick="aSend()">â†‘</button>
    </div>
  </div>
</div>

<!-- TIME -->
<div class="page" id="pTime">
  <div class="vtabs">
    <button class="vtab on" onclick="setVT(&#39;grid&#39;,this)">æ ¼å­å›¾</button>
    <button class="vtab" onclick="setVT(&#39;bar&#39;,this)">æŸ±çŠ¶å›¾</button>
    <button class="vtab" onclick="setVT(&#39;pie&#39;,this)">é¥¼çŠ¶å›¾</button>
  </div>
  <div id="vGrid">
    <div class="palrow" id="palrow"></div>
    <div class="subrow" id="subrow"><span style="font-size:12px;color:var(--text2)">å…ˆé€‰ä¸Šæ–¹é¢œè‰²å¤§ç±»</span></div>
    <div class="gdate">
      <button class="gdbtn" onclick="gNav(-1)">â€¹</button>
      <div class="gdlbl" id="gdlbl"></div>
      <button class="gdbtn" onclick="gNav(1)">â€º</button>
      <button class="gdtoday" onclick="gToday()">ä»Šå¤©</button>
    </div>
    <div class="collapse-row" onclick="toggleMidnight()">
      <span class="collapse-arrow" id="collArrow">â€º</span>
      <span class="collapse-label" id="collLabel">00:00 â€“ 06:00 (æŠ˜å )</span>
      <span class="collapse-info" id="collInfo"></span>
    </div>
    <div class="gwrap"><table class="gtbl" id="gtbl"></table></div>
    <div class="sh"><span class="sh-t">ä»Šæ—¥æ±‡æ€»</span></div>
    <div class="gsum" id="gsum"></div>
  </div>
  <div id="vBar" style="display:none">
    <div class="period-tabs" id="barPT"></div>
    <div class="cnav" id="barNav"></div>
    <div id="barC"></div>
  </div>
  <div id="vPie" style="display:none">
    <div class="period-tabs" id="piePT"></div>
    <div class="cnav" id="pieNav"></div>
    <div id="pieC"></div>
  </div>
</div>

<!-- DAILY -->
<div class="page" id="pDaily">
  <div class="scorecard" id="scorecard"></div>
  <div class="sh"><span class="sh-t">æ¯æ—¥ä»»åŠ¡</span><button class="sh-a" onclick="openM(&#39;adDaily&#39;)">+ æ·»åŠ </button></div>
  <div class="dlist" id="dlist"></div>
  <div class="sh" style="margin-top:8px"><span class="sh-t">ç¦æ­¢äº‹é¡¹</span>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="sh-a" style="background:var(--grd);color:var(--gr);border:1px solid var(--gr);padding:4px 10px;border-radius:20px;font-size:11px" onclick="allForbKept()">âœ“ ä»Šæ—¥å…¨éƒ¨åšå®ˆ</button>
      <button class="sh-a" onclick="openM(&#39;adForb&#39;)">+ æ·»åŠ </button>
    </div>
  </div>
  <div class="flist" id="flist"></div>
</div>

<!-- TASKS -->
<div class="page" id="pTasks">
  <div class="tmtabs" id="tmtabs"></div>
  <div class="tstabs" id="tstabs"></div>
  <div class="sh"><span class="sh-t" id="tlabel">å…¨éƒ¨ä»»åŠ¡</span>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="sh-a" id="doneToggleBtn" onclick="toggleShowDone()" style="font-size:11px;color:var(--text2)">æ˜¾ç¤ºå·²å®Œæˆ</button>
      <button class="sh-a" onclick="openM(&#39;adTask&#39;)">+ æ–°å¢</button>
    </div>
  </div>
  <div class="tlist" id="tlist"></div>
</div>

<!-- STATS -->
<div class="page" id="pStats">
  <div class="sh"><span class="sh-t">ä»Šæ—¥å±æ€§</span></div>
  <div class="sgrid" id="sgrid"></div>
  <div class="sh" style="margin-top:10px"><span class="sh-t">è¿‡å¾€è®°å½•</span></div>
  <div id="hlist"></div>
</div>

</div>
<div class="nav">
  <button class="nb on" id="n-ai" onclick="go(&#39;ai&#39;)"><span class="ic">ğŸ¤–</span><span class="lb">AI</span></button>
  <button class="nb" id="n-time" onclick="go(&#39;time&#39;)"><span class="ic">â±</span><span class="lb">æ—¶é—´å—</span></button>
  <button class="nb" id="n-daily" onclick="go(&#39;daily&#39;)"><span class="ic">ğŸ“‹</span><span class="lb">æ¯æ—¥æŒ‘æˆ˜</span></button>
  <button class="nb" id="n-tasks" onclick="go(&#39;tasks&#39;)"><span class="ic">ğŸš©</span><span class="lb">ä»»åŠ¡ç³»ç»Ÿ</span></button>
  <button class="nb" id="n-stats" onclick="go(&#39;stats&#39;)"><span class="ic">ğŸ“Š</span><span class="lb">ç»Ÿè®¡</span></button>
</div>
<div class="mbg" id="mbg" onclick="bgC(event)">
  <div class="modal">
    <div class="mhdr"><div class="mtit" id="mtit"></div><button class="mclose" onclick="closeM()">Ã—</button></div>
    <div id="mbody"></div>
  </div>
</div>
<script>
// â•â•â• CONFIG â•â•â•
const COLS=[
  {k:'or',l:'ç”Ÿå‘½', a:'hp', h:'#ff8c42',
   s:[{k:'s0',l:'æ´—æ¼±'},{k:'s1',l:'åƒé¥­'},{k:'s2',l:'äº¤é€š'},{k:'s3',l:'å®¶åŠ¡'}]},
  {k:'re',l:'åŠ›é‡', a:'str',h:'#ff4466',
   s:[{k:'s0',l:'å¥èº«'},{k:'s1',l:'åŠ›é‡è®­ç»ƒ'}]},
  {k:'bl',l:'æ™ºåŠ›', a:'int',h:'#4a9eff',
   s:[{k:'s0',l:'è¯»ä¹¦'},{k:'s1',l:'å†™ä½œ'},{k:'s2',l:'å†¥æƒ³'},{k:'s3',l:'å­¦ä¹ '}]},
  {k:'gr',l:'æ•æ·', a:'agi',h:'#3ddc84',
   s:[{k:'s0',l:'è·³ç»³'},{k:'s1',l:'ç‘œä¼½'},{k:'s2',l:'æœ‰æ°§'},{k:'s3',l:'æ‹‰ä¼¸'}]},
  {k:'ye',l:'è‡ªç”±ç‚¹',a:'ap', h:'#ffd060',
   s:[{k:'s0',l:'å·¥ä½œ'},{k:'s1',l:'åŠäº‹'},{k:'s2',l:'å‰ªè¾‘'},{k:'s3',l:'ç¼–ç¨‹'}]},
  {k:'gy',l:'ä¼‘æ¯', a:null, h:'#7777bb',
   s:[{k:'s0',l:'ç¡è§‰'},{k:'s1',l:'ä¼‘æ¯'},{k:'s2',l:'åˆ·æ‰‹æœº'},{k:'s3',l:'ç©æ¸¸æˆ'}]},
];
const ATTRS=[
  {k:'hp', l:'ç”Ÿå‘½', c:'#ff8c42'},
  {k:'str',l:'åŠ›é‡', c:'#ff4466'},
  {k:'int',l:'æ™ºåŠ›', c:'#4a9eff'},
  {k:'agi',l:'æ•æ·', c:'#3ddc84'},
  {k:'ap', l:'è‡ªç”±ç‚¹',c:'#ffd060'},
];
// Sub shading: idx0=full, idx1=80%, idx2=60%, idx3=45%
const SHADE=[1,0.8,0.6,0.45];

// â•â•â• STATE â•â•â•
let S={
  start:'2026-01-12',
  grid:{},
  daily:[
    {id:'d1',n:'6ç‚¹èµ·åºŠ',   ic:'â°',r:'',        st:'p',sk:0},
    {id:'d2',n:'å†¥æƒ³',      ic:'ğŸ§˜',r:'æ—©+æ™š',   st:'p',sk:0},
    {id:'d3',n:'å¥èº«',      ic:'ğŸ’ª',r:'â‰¥1.5å°æ—¶',st:'p',sk:0},
    {id:'d4',n:'ç‘œä¼½',      ic:'ğŸ¤¸',r:'â‰¥0.5å°æ—¶',st:'p',sk:0},
    {id:'d5',n:'è¯»ä¹¦',      ic:'ğŸ“š',r:'â‰¥0.5å°æ—¶',st:'p',sk:0},
    {id:'d6',n:'å­¦æ–°æŠ€èƒ½',  ic:'ğŸ¯',r:'â‰¥0.5å°æ—¶',st:'p',sk:0},
    {id:'d7',n:'æ—¥æ›´è§†é¢‘',  ic:'ğŸ¬',r:'',        st:'p',sk:0},
    {id:'d8',n:'è®°è´¦',      ic:'ğŸ’°',r:'',        st:'p',sk:0},
  ],
  forb:[
    {id:'f1',n:'æˆ’çƒŸ',  ic:'ğŸš¬',st:'p',d:0},
    {id:'f2',n:'æˆ’ç³–',  ic:'ğŸ¬',st:'p',d:0},
    {id:'f3',n:'æˆ’é…’',  ic:'ğŸº',st:'p',d:0},
    {id:'f4',n:'æˆ’æ¸¸æˆ',ic:'ğŸ®',st:'p',d:0},
  ],
  tasks:[
    {id:'t1',t:'å®Œæˆäººç”Ÿæ¸¸æˆ',    tp:'ml',n:'ç»ˆæä¸»çº¿', done:false,due:null},
    {id:'t2',t:'ä½“è„‚ç‡å‡åˆ°15%',   tp:'ml',n:'å½“å‰24.5%',done:false,due:null},
    {id:'t3',t:'æ—¥æ›´åˆ°2027å¹´',    tp:'ml',n:'',         done:false,due:null},
    {id:'t4',t:'èµšé’±ï¼ˆè¿˜å€ºï¼‰',    tp:'ml',n:'è´Ÿå€ºçº¦30ä¸‡',done:false,due:null},
    {id:'t5',t:'æ•´ç†è®°å¿†æ–‡æ¡£',    tp:'mt',n:'å‚è€ƒ1.11', done:false,due:null},
    {id:'t6',t:'ä»Šå¹´è¯»å®Œ100æœ¬ä¹¦', tp:'sl',n:'è¿›åº¦0/100',done:false,due:null},
    {id:'t7',t:'ç»†åˆ†äººç”Ÿæ¸¸æˆå†…æ¶µä»»åŠ¡',tp:'bx',n:'',    done:false,due:null},
    {id:'t8',t:'å»å¦ˆå—å²¸åŒºå®¶è£…ç›‘æ§', tp:'bx',n:'',     done:false,due:null},
  ],
  aiH:[],
  gDate:'',
  bPer:'today',bOff:0,
  pPer:'today',pOff:0,
};
// task types: mt=ä¸»çº¿ä»Šæ—¥ ml=ä¸»çº¿é•¿æœŸ st=æ”¯çº¿ä»Šæ—¥ sl=æ”¯çº¿é•¿æœŸ bx=æ”¶é›†ç®± ov=é¡ºå»¶

const sv=()=>{try{localStorage.setItem('lg4',JSON.stringify(S))}catch(e){}};
const ld=()=>{try{const d=localStorage.getItem('lg4');if(d){const p=JSON.parse(d);S={...S,...p}}}catch(e){}};
const tod=()=>new Date().toISOString().slice(0,10);
// Streak: consecutive days used. Break of 1 day = no reset, break of 2+ days = reset
function getStreak(){
  const t=tod();
  if(!S.lastUse){S.lastUse=t;S.streak=1;sv();}
  else{
    const last=new Date(S.lastUse+'T00:00:00');
    const now=new Date(t+'T00:00:00');
    const diff=Math.round((now-last)/864e5);
    if(diff===0){/* same day, no change */}
    else if(diff===1){S.streak=(S.streak||1);S.lastUse=t;sv();}// 1 day gap: keep streak, update date
    else if(diff>=2){S.streak=1;S.lastUse=t;sv();}// 2+ days: reset
    else{S.lastUse=t;sv();}
  }
  return S.streak||1;
}
const dn=()=>getStreak();
const fmtD=d=>{const dt=new Date(d+'T00:00:00'),ds=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];return`${dt.getMonth()+1}/${dt.getDate()} æ˜ŸæœŸ${ds[dt.getDay()]}`;};
const getG=d=>{if(!S.grid[d])S.grid[d]=Array(96).fill(null);return S.grid[d];};
function compA(date){
  const g=getG(date),r={hp:0,str:0,int:0,agi:0,ap:0};
  g.forEach(c=>{if(!c)return;const col=COLS.find(x=>x.k===c.c);if(col&&col.a)r[col.a]+=0.25;});
  return r;
}

// â•â•â• HEADER â•â•â•
function rHdr(){
  const now=new Date(),ds=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  document.getElementById('hdrDate').textContent=`${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ æ˜ŸæœŸ${ds[now.getDay()]}`;
  document.getElementById('dayBadge').textContent=`Day ${dn()}`;
  const a=compA(tod());
  document.getElementById('astrip').innerHTML=ATTRS.map(x=>`
    <div class="achip"><span class="v" style="color:${x.c}">${a[x.k].toFixed(2)}</span><span class="l">${x.l}</span></div>`).join('');
}

// â•â•â• NAV â•â•â•
const PAGES={ai:'pAI',time:'pTime',daily:'pDaily',tasks:'pTasks',stats:'pStats'};
function go(name){
  Object.entries(PAGES).forEach(([k,v])=>{
    document.getElementById(v).classList.toggle('active',k===name);
    document.getElementById('n-'+k).classList.toggle('on',k===name);
  });
  if(name==='time')rTime();
  if(name==='daily')rDaily();
  if(name==='tasks')rTasks();
  if(name==='stats')rStats();
}

// â•â•â• AI â•â•â•
const QUICK=[
  {l:'ğŸ“Š ä»Šæ—¥å±æ€§',f:qAttr},{l:'ğŸ“‹ æ¯æ—¥è¿›åº¦',f:qDaily},
  {l:'ğŸš© ä»Šæ—¥ä»»åŠ¡',f:qTasks},{l:'ğŸ“ è®°å¿†è¡¥ä¸',f:qPatch},
];
function initAI(){
  const qr=document.getElementById('qrow');qr.innerHTML='';
  QUICK.forEach(q=>{const b=document.createElement('button');b.className='qchip';b.textContent=q.l;b.onclick=q.f;qr.appendChild(b);});
  if(!S.aiH.length){
    addM('a',`ä½ å¥½ï¼ŒKuanã€‚ä»Šå¤© ${tod()}ï¼ŒDay ${dn()}ã€‚\n\nç³»ç»Ÿå·²å°±ç»ªï¼Œå¯ç›´æ¥å‘Šè¯‰æˆ‘ä»Šå¤©åšäº†ä»€ä¹ˆï¼Œæˆ–ç‚¹ä¸Šæ–¹å¿«æ·é”®ã€‚`);
  } else {
    const el=document.getElementById('aiMsgs');
    el.innerHTML='<div class="spacer"></div>';
    S.aiH.slice(-20).forEach(m=>appM(m.r,m.t,m.ts));
    el.scrollTop=el.scrollHeight;
  }
}
function appM(r,t,ts){
  const el=document.getElementById('aiMsgs');
  const d=document.createElement('div');d.className=`msg ${r==='a'?'a':'u'}`;
  const tm=new Date(ts||Date.now());
  d.innerHTML=`<div class="bubble">${t}</div><div class="msg-t">${String(tm.getHours()).padStart(2,'0')}:${String(tm.getMinutes()).padStart(2,'0')}</div>`;
  el.insertBefore(d,el.lastChild);el.scrollTop=el.scrollHeight;
}
function addM(r,t){
  appM(r,t,Date.now());S.aiH.push({r,t,ts:Date.now()});sv();
}
function showDots(){
  const el=document.getElementById('aiMsgs');
  const d=document.createElement('div');d.className='msg a';d.id='dots';
  d.innerHTML=`<div class="bubble"><div class="dots"><span></span><span></span><span></span></div></div>`;
  el.insertBefore(d,el.lastChild);el.scrollTop=el.scrollHeight;
}
function hideDots(){const e=document.getElementById('dots');if(e)e.remove();}
// Parse time string "18:00" -> index in grid (hour*4 + quarter)
function timeToIdx(t){
  const [h,m]=t.split(':').map(Number);
  return h*4+Math.floor(m/15);
}
function idxToTime(i){
  const h=Math.floor(i/4),m=(i%4)*15;
  return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
}
// Write time range to grid with color+sub
function writeGrid(date,startStr,endStr,colorKey,subKey){
  const g=getG(date);
  let si=timeToIdx(startStr),ei=timeToIdx(endStr);
  if(ei<=si)ei=Math.min(96,si+4); // safety
  for(let i=si;i<Math.min(ei,96);i++) g[i]={c:colorKey,s:subKey};
  sv();rHdr();if(document.getElementById('pTime').classList.contains('active'))rTime();
}
// Find color key by label or sub label
function findColorBySub(subLabel){
  for(const col of COLS){
    for(const s of col.s){
      if(subLabel.includes(s.l)||s.l.includes(subLabel)) return{colorKey:col.k,subKey:s.k,colorLabel:col.l,subLabel:s.l};
    }
  }
  return null;
}
function findColorByLabel(label){
  const l=label.toLowerCase();
  for(const col of COLS){
    if(l.includes(col.l)||col.l.includes(label)) return{colorKey:col.k,subKey:col.s[0].k,colorLabel:col.l,subLabel:col.s[0].l};
  }
  return null;
}

async function aSend(){
  const inp=document.getElementById('ainput');
  const txt=inp.value.trim();if(!txt)return;
  inp.value='';inp.style.height='auto';
  addM('u',txt);
  const a=compA(tod()),g=getG(tod());
  const dn2=S.daily.filter(x=>x.st==='d').map(x=>x.n);
  const pn=S.daily.filter(x=>x.st==='p').map(x=>x.n);
  const fn=S.daily.filter(x=>x.st==='f').map(x=>x.n);
  const tt=S.tasks.filter(x=>(x.tp==='mt')&&!x.done).map(x=>x.t);

  const sys=`ä½ æ˜¯Kuançš„äººç”Ÿæ¸¸æˆå‘å¯¼AIã€‚ä¸¥æ ¼åè®®ï¼š
1.ç¦æ­¢æé€ æ•°å€¼ã€‚å½“å‰:${tod()} Day${dn()}ã€‚
2.é¢œè‰²ç³»ç»Ÿï¼šæ©™=ç”Ÿå‘½(æ´—æ¼±/åƒé¥­/äº¤é€š/å®¶åŠ¡) çº¢=åŠ›é‡(å¥èº«/åŠ›é‡è®­ç»ƒ) è“=æ™ºåŠ›(è¯»ä¹¦/å†™ä½œ/å†¥æƒ³/å­¦ä¹ ) ç»¿=æ•æ·(è·³ç»³/ç‘œä¼½/æœ‰æ°§/æ‹‰ä¼¸) é»„=è‡ªç”±ç‚¹(å·¥ä½œ/åŠäº‹/å‰ªè¾‘/ç¼–ç¨‹) ç°=ä¼‘æ¯(ç¡è§‰/ä¼‘æ¯/åˆ·æ‰‹æœº/ç©æ¸¸æˆ)ã€‚
3.å±æ€§è®¡ç®—ï¼šæ¯15åˆ†é’Ÿ=0.25å±æ€§ç‚¹ã€‚1å°æ—¶=1.00ç‚¹ï¼Œ2å°æ—¶=2.00ç‚¹ã€‚
4.ä»Šæ—¥å·²æœ‰å±æ€§:ç”Ÿå‘½${a.hp.toFixed(2)} åŠ›é‡${a.str.toFixed(2)} æ™ºåŠ›${a.int.toFixed(2)} æ•æ·${a.agi.toFixed(2)} è‡ªç”±ç‚¹${a.ap.toFixed(2)}ã€‚
5.ä»Šæ—¥æ—¶é—´æ ¼å­:${g.filter(c=>c).length}æ ¼(${(g.filter(c=>c).length*0.25).toFixed(2)}h)ã€‚
6.æ¯æ—¥ä»»åŠ¡:âœ“${dn2.join('Â·')||'æ— '} â—‹${pn.join('Â·')||'æ— '} âœ—${fn.join('Â·')||'æ— '}ã€‚
7.ä»Šæ—¥ä¸»çº¿å¾…åŠ:${tt.join('Â·')||'æ— '}ã€‚
8.é‡è¦ï¼šç”¨æˆ·æè¿°æ—¶é—´æ®µ+è¡Œä¸ºæ—¶ï¼Œå¿…é¡»åœ¨å›å¤æœ«å°¾é™„åŠ JSONè®°å½•æŒ‡ä»¤ï¼Œæ ¼å¼å¦‚ä¸‹(ä¸è¦æœ‰ä»£ç å—æ ‡è®°)ï¼š
GRID_RECORD:{"date":"YYYY-MM-DD","start":"HH:MM","end":"HH:MM","color":"é¢œè‰²key(or/re/bl/gr/ye/gy)","sub":"å°é¡¹key(s0/s1/s2/s3)","colorLabel":"å¤§é¡¹å","subLabel":"å°é¡¹å"}
ä¾‹å¦‚ç”¨æˆ·è¯´"18:00-20:00é™ªå®¶äººåŒ…é¥ºå­ï¼Œå±äºæ©™è‰²ç”Ÿå‘½å®¶åŠ¡"ï¼Œé¢œè‰²ä¸ºorï¼Œå°é¡¹å®¶åŠ¡ä¸ºs3ï¼Œåˆ™é™„åŠ ï¼š
GRID_RECORD:{"date":"${tod()}","start":"18:00","end":"20:00","color":"or","sub":"s3","colorLabel":"ç”Ÿå‘½","subLabel":"å®¶åŠ¡"}
9.å¦‚æœç”¨æˆ·æ²¡è¯´å…·ä½“æ—¶é—´æˆ–é¢œè‰²ï¼Œä¸è¦æ·»åŠ GRID_RECORDï¼Œç›´æ¥è¯¢é—®ã€‚
10.ç”¨æˆ·æåˆ°æŸå°é¡¹(å¦‚"å®¶åŠ¡""æ´—æ¼±""è¯»ä¹¦"ç­‰)æ—¶è‡ªåŠ¨å¯¹åº”åˆ°æ­£ç¡®é¢œè‰²å¤§é¡¹å’Œå°é¡¹ã€‚
å›å¤ç®€æ´ï¼Œæœ‰å…·ä½“æ•°å­—ï¼Œä¸ç”¨markdownæ ¼å¼ï¼Œä¸ç”¨æ˜Ÿå·åŠ ç²—ã€‚`;

  const hist=S.aiH.slice(-8).map(m=>({role:m.r==='a'?'assistant':'user',content:m.t}));
  showDots();
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,system:sys,
        messages:[...hist,{role:'user',content:txt}]})});
    const data=await res.json();hideDots();
    let reply=data.content?.map(c=>c.text||'').join('')||'è¿æ¥å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚';

    // Parse GRID_RECORD from reply
    const gridMatch=reply.match(/GRID_RECORD:(\{[^\n]+\})/);
    if(gridMatch){
      try{
        const rec=JSON.parse(gridMatch[1]);
        writeGrid(rec.date||tod(),rec.start,rec.end,rec.color,rec.sub);
        // Calculate attrs added
        const si=timeToIdx(rec.start),ei=timeToIdx(rec.end);
        const cells=Math.min(ei,96)-si;
        const pts=(cells*0.25).toFixed(2);
        // Remove the GRID_RECORD line from reply
        reply=reply.replace(/\nGRID_RECORD:[^\n]+/,'').replace(/GRID_RECORD:[^\n]+/,'').trim();
        reply+=`\n\nâœ… å·²å†™å…¥æ—¶é—´æ ¼å­ï¼š${rec.start}-${rec.end} ${rec.colorLabel}Â·${rec.subLabel}ï¼ˆ${cells}æ ¼ï¼Œ+${pts}å±æ€§ç‚¹ï¼‰`;
      }catch(e){}
    }
    addM('a',reply);
  }catch(e){hideDots();addM('a','ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥ã€‚');}
}
function aKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();aSend();}}
function aResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function qAttr(){const a=compA(tod()),g=getG(tod());addM('a',`ğŸ“Š ä»Šæ—¥å±æ€§ï¼ˆ${tod()}ï¼‰\nç”Ÿå‘½  +${a.hp.toFixed(2)}\nåŠ›é‡  +${a.str.toFixed(2)}\næ™ºåŠ›  +${a.int.toFixed(2)}\næ•æ·  +${a.agi.toFixed(2)}\nè‡ªç”±ç‚¹ +${a.ap.toFixed(2)}\n\nå·²è®°å½• ${g.filter(c=>c).length} æ ¼ï¼ˆ${(g.filter(c=>c).length*0.25).toFixed(2)}hï¼‰`);}
function qDaily(){const d=S.daily.filter(x=>x.st==='d'),p=S.daily.filter(x=>x.st==='p'),f=S.daily.filter(x=>x.st==='f');let t='ğŸ“‹ æ¯æ—¥æŒ‘æˆ˜è¿›åº¦\n\n';if(d.length)t+=`âœ… å·²å®Œæˆ (${d.length})\n${d.map(x=>x.n).join(' Â· ')}\n\n`;if(p.length)t+=`â³ å¾…å®Œæˆ (${p.length})\n${p.map(x=>x.n).join(' Â· ')}\n\n`;if(f.length)t+=`âŒ å·²å¤±è´¥ (${f.length})\n${f.map(x=>x.n).join(' Â· ')}`;addM('a',t.trim());}
function qTasks(){const m=S.tasks.filter(x=>x.tp==='mt'&&!x.done),s=S.tasks.filter(x=>x.tp==='st'&&!x.done),o=S.tasks.filter(x=>x.tp==='ov');let t='ğŸš© ä»Šæ—¥å¾…åŠ\n\n';if(m.length)t+=`ä¸»çº¿\n${m.map(x=>'â—‹ '+x.t).join('\n')}\n\n`;if(s.length)t+=`æ”¯çº¿\n${s.map(x=>'â—‹ '+x.t).join('\n')}\n\n`;if(o.length)t+=`âš ï¸ é¡ºå»¶\n${o.map(x=>'â€¢ '+x.t).join('\n')}`;if(!m.length&&!s.length&&!o.length)t+='ä»Šæ—¥æ— å¾…åŠ ğŸ‰';addM('a',t.trim());}
function qPatch(){const a=compA(tod());const dn2=S.daily.filter(x=>x.st==='d').map(x=>x.n);const fn=S.daily.filter(x=>x.st==='f').map(x=>x.n);const dt=S.tasks.filter(x=>x.tp==='mt'&&x.done).map(x=>x.t);let p=`ğŸ“¥ è®°å¿†è¡¥ä¸ï¼ˆ${tod()} Â· Day ${dn()}ï¼‰\n\nã€å±æ€§ç»“ç®—ã€‘\nç”Ÿå‘½:${a.hp.toFixed(2)} åŠ›é‡:${a.str.toFixed(2)} æ™ºåŠ›:${a.int.toFixed(2)} æ•æ·:${a.agi.toFixed(2)} è‡ªç”±ç‚¹:${a.ap.toFixed(2)}\n\nã€æ¯æ—¥ä»»åŠ¡ã€‘âœ…${dn2.join('ã€')||'æ— '} âŒ${fn.join('ã€')||'æ— '}\n\n`;if(dt.length)p+=`ã€å·²å®Œæˆä¸»çº¿ã€‘\n${dt.map(x=>'â€¢ '+x).join('\n')}\n\n`;p+=`ã€å­˜å…¥ã€‘â†’ 6.1 å‰§æƒ…æ¦‚è¦ â†’ 5.1 ä»»åŠ¡è®°å½•`;addM('a',p);}

// â•â•â• TIME â•â•â•
let sCol='or',sSub=null,isDrag=false,midnightExp=false;

function toggleMidnight(){
  midnightExp=!midnightExp;
  buildGrid();
}
function rTime(){if(!S.gDate)S.gDate=tod();rPal();rSub();buildGrid();}
function setVT(v,btn){
  document.querySelectorAll('.vtab').forEach(t=>t.classList.remove('on'));btn.classList.add('on');
  document.getElementById('vGrid').style.display=v==='grid'?'block':'none';
  document.getElementById('vBar').style.display=v==='bar'?'block':'none';
  document.getElementById('vPie').style.display=v==='pie'?'block':'none';
  if(v==='bar')rBar();if(v==='pie')rPie();
}
function rPal(){
  const r=document.getElementById('palrow');r.innerHTML='';
  COLS.forEach(c=>{
    const el=document.createElement('div');el.className='palitem'+(c.k===sCol?' on':'');
    el.innerHTML=`<div class="paldot" style="background:${c.h}"></div><span>${c.l}</span>`;
    el.onclick=()=>{sCol=c.k;sSub=null;rPal();rSub();};
    r.appendChild(el);
  });
  const cl=document.createElement('div');cl.className='palitem'+(sCol==='clr'?' on':'');
  cl.innerHTML=`<div class="paldot" style="background:var(--bg3);border:2px dashed var(--border2)"></div><span>æ¸…é™¤</span>`;
  cl.onclick=()=>{sCol='clr';sSub=null;rPal();rSub();};
  r.appendChild(cl);
}
function rSub(){
  const r=document.getElementById('subrow');
  if(sCol==='clr'||!sCol){r.innerHTML=`<span style="font-size:12px;color:var(--text2)">å…ˆé€‰ä¸Šæ–¹é¢œè‰²å¤§ç±»</span>`;return;}
  const col=COLS.find(c=>c.k===sCol);if(!col){r.innerHTML='';return;}
  r.innerHTML='';
  col.s.forEach((s,i)=>{
    const isOn=sSub===s.k;
    const sh=SHADE[Math.min(i,SHADE.length-1)];
    const bg=`rgba(${parseInt(col.h.slice(1,3),16)},${parseInt(col.h.slice(3,5),16)},${parseInt(col.h.slice(5,7),16)},${sh})`;
    const chip=document.createElement('div');
    chip.className='subchip'+(isOn?' on':'');
    chip.style.cssText=isOn?`background:${col.h};color:#0a0a0f`:`background:${bg};color:#fff`;
    chip.innerHTML=`${s.l}<span class="sub-del" onclick="event.stopPropagation();delSub('${col.k}','${s.k}')">Ã—</span>`;
    chip.onclick=()=>setSub(s.k);
    r.appendChild(chip);
  });
  // Add sub button
  const addBtn=document.createElement('button');
  addBtn.className='sub-add-btn';addBtn.textContent='+ æ·»åŠ å°é¡¹';
  addBtn.onclick=()=>promptAddSub(col.k,col.l);
  r.appendChild(addBtn);
}
function delSub(colorKey,subKey){
  const col=COLS.find(c=>c.k===colorKey);if(!col)return;
  if(col.s.length<=1){alert('è‡³å°‘ä¿ç•™ä¸€ä¸ªå°é¡¹');return;}
  col.s=col.s.filter(s=>s.k!==subKey);
  if(sSub===subKey)sSub=col.s[0]?.k||null;
  rSub();
}
function promptAddSub(colorKey,colorLabel){
  const name=prompt(`ä¸ºã€Œ${colorLabel}ã€æ·»åŠ æ–°å°é¡¹åç§°ï¼š`);
  if(!name||!name.trim())return;
  const col=COLS.find(c=>c.k===colorKey);if(!col)return;
  const newKey='s'+Date.now();
  col.s.push({k:newKey,l:name.trim()});
  sSub=newKey;
  rSub();
}
function buildGrid(){
  document.getElementById('gdlbl').textContent=fmtD(S.gDate)+(S.gDate===tod()?' Â· ä»Šå¤©':'');
  const g=getG(S.gDate),tbl=document.getElementById('gtbl');tbl.innerHTML='';

  // Update collapse button state
  const midFilled=g.slice(0,24).filter(c=>c).length;
  const arrow=document.getElementById('collArrow');
  const label=document.getElementById('collLabel');
  const info=document.getElementById('collInfo');
  if(arrow)arrow.className='collapse-arrow'+(midnightExp?' open':'');
  if(label)label.textContent=midnightExp?'00:00 â€“ 06:00 (ç‚¹å‡»æŠ˜å )':'00:00 â€“ 06:00 (ç‚¹å‡»å±•å¼€)';
  if(info)info.textContent=midFilled>0?`å·²è®°å½•${midFilled}æ ¼`:'ç©º';

  // colgroup for equal widths
  const cg=document.createElement('colgroup');
  const hc=document.createElement('col');hc.className='hcol';cg.appendChild(hc);
  for(let i=0;i<4;i++){const qc=document.createElement('col');qc.className='qcol';cg.appendChild(qc);}
  tbl.appendChild(cg);

  const startH=midnightExp?0:6;
  for(let h=startH;h<24;h++){
    const tr=document.createElement('tr');
    const th=document.createElement('td');th.className='hlbl';
    th.textContent=String(h).padStart(2,'0')+':00';tr.appendChild(th);
    for(let q=0;q<4;q++){
      const idx=h*4+q,cell=g[idx];
      const td=document.createElement('td');td.className='gcell';td.dataset.idx=idx;
      if(cell){
        td.classList.add('c-'+cell.c);
        const col=COLS.find(c=>c.k===cell.c);
        const si=col?col.s.findIndex(s=>s.k===cell.s):0;
        const sh=SHADE[Math.min(si<0?0:si,SHADE.length-1)];
        td.style.opacity=sh;
        if(col&&si>=0&&col.s[si]){
          const lbl=document.createElement('div');
          lbl.className='gcell-lbl';
          lbl.textContent=col.s[si].l.slice(0,2);
          td.appendChild(lbl);
        }
      }
      td.addEventListener('touchstart',e=>{e.preventDefault();isDrag=true;paint(td,idx);},{passive:false});
      td.addEventListener('touchmove',e=>{
        e.preventDefault();if(!isDrag)return;
        const el=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);
        if(el&&el.dataset.idx!==undefined)paint(el,+el.dataset.idx);
      },{passive:false});
      td.addEventListener('mousedown',()=>{isDrag=true;paint(td,idx);});
      td.addEventListener('mouseenter',()=>{if(isDrag)paint(td,idx);});
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
  document.addEventListener('mouseup',endDrag);
  document.addEventListener('touchend',endDrag);
  rGSum();
}
function endDrag(){if(isDrag){isDrag=false;sv();rHdr();rGSum();}}
function paint(td,idx){
  const g=getG(S.gDate);
  if(sCol==='clr'){g[idx]=null;td.className='gcell';td.style.opacity='';td.innerHTML='';}
  else{
    const sub=sSub||(COLS.find(c=>c.k===sCol)?.s[0]?.k||null);
    g[idx]={c:sCol,s:sub};
    td.className=`gcell c-${sCol}`;
    const col=COLS.find(c=>c.k===sCol);
    const si=col?col.s.findIndex(s=>s.k===sub):0;
    td.style.opacity=SHADE[Math.min(si<0?0:si,SHADE.length-1)];
    td.innerHTML='';
    if(col&&si>=0&&col.s[si]){
      const lbl=document.createElement('div');
      lbl.className='gcell-lbl';lbl.textContent=col.s[si].l.slice(0,2);
      td.appendChild(lbl);
    }
  }
}
function rGSum(){
  const g=getG(S.gDate);
  const cts={};COLS.forEach(c=>{cts[c.k]={tot:0,s:{}};c.s.forEach(s=>cts[c.k].s[s.k]=0);});
  g.forEach(c=>{if(!c||!cts[c.c])return;cts[c.c].tot++;if(c.s&&cts[c.c].s[c.s]!==undefined)cts[c.c].s[c.s]++;});
  const tot=Object.values(cts).reduce((a,b)=>a+b.tot,0);
  const w=document.getElementById('gsum');
  if(!tot){w.innerHTML=`<div class="empty"><div class="ei">ğŸ•</div><p>é€‰é¢œè‰²åæ‹–åŠ¨æ ¼å­å¼€å§‹è®°å½•</p></div>`;return;}
  w.innerHTML=COLS.filter(c=>cts[c.k].tot>0).map(c=>{
    const col=COLS.find(x=>x.k===c.k);
    const hrs=(cts[c.k].tot*0.25).toFixed(2);
    const attr=c.a?(cts[c.k].tot*0.25).toFixed(2):null;
    const subTxt=col.s.filter(s=>cts[c.k].s[s.k]>0)
      .map(s=>`${s.l} ${(cts[c.k].s[s.k]*0.25).toFixed(2)}h`).join('  ');
    return`<div class="gsrow">
      <div class="gsdot" style="background:${c.h}"></div>
      <div><div class="gsname">${c.l}</div>${subTxt?`<div class="gssubs">${subTxt}</div>`:''}</div>
      <div style="margin-left:auto;text-align:right">
        <div class="gstime">${hrs}h</div>
        ${attr?`<div class="gsattr" style="color:${c.h}">+${attr}</div>`:''}
      </div>
    </div>`;
  }).join('');
}
function gNav(d){const dt=new Date(S.gDate+'T00:00:00');dt.setDate(dt.getDate()+d);S.gDate=dt.toISOString().slice(0,10);sv();buildGrid();}
function gToday(){S.gDate=tod();sv();buildGrid();}

// Charts
function getDR(per,off){
  const now=new Date();
  if(per==='today'){const d=new Date(now);d.setDate(d.getDate()+off);return[d.toISOString().slice(0,10)];}
  if(per==='yesterday'){const d=new Date(now);d.setDate(d.getDate()-1+off);return[d.toISOString().slice(0,10)];}
  if(per==='week'){
    const d=new Date(now);const day=(d.getDay()||7)-1;d.setDate(d.getDate()-day+off*7);
    return Array.from({length:7},(_,i)=>{const x=new Date(d);x.setDate(d.getDate()+i);return x.toISOString().slice(0,10);});
  }
  if(per==='month'){
    const d=new Date(now.getFullYear(),now.getMonth()+off,1);
    const ds=[];while(d.getMonth()===new Date(now.getFullYear(),now.getMonth()+off,1).getMonth()){ds.push(d.toISOString().slice(0,10));d.setDate(d.getDate()+1);}
    return ds;
  }
  return[tod()];
}
function perLbl(per,off){
  const ds=getDR(per,off);
  if(ds.length===1){const s=ds[0];return fmtD(s)+(s===tod()?' Â· ä»Šå¤©':s===new Date(new Date().setDate(new Date().getDate()-1)).toISOString().slice(0,10)?' Â· æ˜¨å¤©':'');}
  return`${ds[0].slice(5)} ~ ${ds[ds.length-1].slice(5)}`;
}
const PERS=[{k:'today',l:'ä»Šå¤©'},{k:'yesterday',l:'æ˜¨å¤©'},{k:'week',l:'æœ¬å‘¨'},{k:'month',l:'æœ¬æœˆ'}];
function rBar(){
  document.getElementById('barPT').innerHTML=PERS.map(p=>`<button class="ptab${S.bPer===p.k?' on':''}" onclick="S.bPer='${p.k}';S.bOff=0;sv();rBar()">${p.l}</button>`).join('');
  document.getElementById('barNav').innerHTML=`<button class="cnbtn" onclick="S.bOff--;sv();rBar()">â€¹</button><div class="cnlbl">${perLbl(S.bPer,S.bOff)}</div><button class="cnbtn" onclick="S.bOff++;sv();rBar()">â€º</button>`;
  const dates=getDR(S.bPer,S.bOff);
  const tot={hp:0,str:0,int:0,agi:0,ap:0};
  dates.forEach(d=>{const a=compA(d);Object.keys(tot).forEach(k=>tot[k]+=a[k]);});
  const max=Math.max(...Object.values(tot),0.25);
  document.getElementById('barC').innerHTML=`<div class="cbox"><div class="ctitle">å±æ€§æ€»è®¡</div>${ATTRS.map(a=>`<div class="brow"><div class="blbl" style="color:${a.c}">${a.l}</div><div class="btrack"><div class="bfill" style="width:${tot[a.k]/max*100}%;background:${a.c}"></div></div><div class="bval">${tot[a.k].toFixed(2)}</div></div>`).join('')}</div>`;
}
function rPie(){
  document.getElementById('piePT').innerHTML=PERS.map(p=>`<button class="ptab${S.pPer===p.k?' on':''}" onclick="S.pPer='${p.k}';S.pOff=0;sv();rPie()">${p.l}</button>`).join('');
  document.getElementById('pieNav').innerHTML=`<button class="cnbtn" onclick="S.pOff--;sv();rPie()">â€¹</button><div class="cnlbl">${perLbl(S.pPer,S.pOff)}</div><button class="cnbtn" onclick="S.pOff++;sv();rPie()">â€º</button>`;
  const dates=getDR(S.pPer,S.pOff);
  const cts={};COLS.forEach(c=>cts[c.k]=0);
  dates.forEach(d=>getG(d).forEach(c=>{if(c&&cts[c.c]!==undefined)cts[c.c]++;}));
  const tot=Object.values(cts).reduce((a,b)=>a+b,0);
  const pc=document.getElementById('pieC');
  if(!tot){pc.innerHTML=`<div class="cbox"><div class="empty"><p>è¯¥æ—¶æ®µæš‚æ— è®°å½•</p></div></div>`;return;}
  const R=52,cx=62,cy=62;let ang=-Math.PI/2,paths='';
  const valid=COLS.filter(c=>cts[c.k]>0);
  valid.forEach(c=>{const ratio=cts[c.k]/tot,sw=ratio*2*Math.PI;const x1=cx+R*Math.cos(ang),y1=cy+R*Math.sin(ang);ang+=sw;const x2=cx+R*Math.cos(ang),y2=cy+R*Math.sin(ang);if(valid.length===1)paths+=`<circle cx="${cx}" cy="${cy}" r="${R}" fill="${c.h}"/>`;else paths+=`<path d="M${cx},${cy}L${x1},${y1}A${R},${R},0,${sw>Math.PI?1:0},1,${x2},${y2}Z" fill="${c.h}"/>`;});
  pc.innerHTML=`<div class="cbox"><div class="ctitle">æ—¶é—´åˆ†å¸ƒ</div><div class="pie-wrap"><svg width="124" height="124" viewBox="0 0 124 124">${paths}</svg><div class="pie-leg">${valid.map(c=>`<div class="pie-item"><div class="pie-dot" style="background:${c.h}"></div><div class="pie-name">${c.l}</div><div class="pie-val">${(cts[c.k]*0.25).toFixed(2)}h</div></div>`).join('')}</div></div></div>`;
}

// â•â•â• DAILY â•â•â•
function rDaily(){
  const done=S.daily.filter(x=>x.st==='d').length,tot=S.daily.length;
  const pct=tot?Math.round(done/tot*100):0;
  const co=138.2*(1-pct/100);
  document.getElementById('scorecard').innerHTML=`
    <svg width="58" height="58"><circle cx="29" cy="29" r="22" fill="none" stroke="#1c1c32" stroke-width="5"/>
    <circle cx="29" cy="29" r="22" fill="none" stroke="${pct===100?'#3ddc84':'#ffd060'}" stroke-width="5"
      stroke-dasharray="138.2" stroke-dashoffset="${co}" stroke-linecap="round" transform="rotate(-90 29 29)"/></svg>
    <div style="flex:1">
      <div style="font-size:26px;font-weight:900;font-family:'Share Tech Mono',monospace;color:${pct===100?'#3ddc84':'#ffd060'}">${pct}%</div>
      <div style="font-size:12px;color:var(--text2);margin-top:2px">${done}/${tot} å®Œæˆ</div>
    </div>
    ${pct===100?'<div style="font-size:13px;font-weight:700;background:linear-gradient(90deg,#4a9eff,#3ddc84);-webkit-background-clip:text;-webkit-text-fill-color:transparent">ğŸ’ å…¨å‹¤ï¼</div>':''}`;
  document.getElementById('dlist').innerHTML=S.daily.map(t=>`
    <div class="dcard ${t.st==='d'?'done':t.st==='f'?'fail':''}" onclick="cycD('${t.id}')">
      <div class="dchk">${t.st==='d'?'âœ“':t.st==='f'?'âœ—':''}</div>
      <div class="dico">${t.ic||'ğŸ“Œ'}</div>
      <div class="dinfo"><div class="dname">${t.n}</div>${t.r?`<div class="dreq">${t.r}</div>`:''}</div>
      ${t.sk>0?`<div class="strk">ğŸ”¥${t.sk}å¤©</div>`:''}
      <button onclick="event.stopPropagation();delD('${t.id}')" style="background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:0 2px;flex-shrink:0">Ã—</button>
    </div>`).join('');
  document.getElementById('flist').innerHTML=S.forb.map(f=>`
    <div class="fcard ${f.st==='kept'?'kept':f.st==='broke'?'broke':''}" onclick="cycF('${f.id}')">
      <span style="font-size:20px">${f.ic}</span>
      <span style="flex:1;font-size:14px;font-weight:600">${f.n}</span>
      <span class="fstat">${f.st==='kept'?`âœ“ ${f.d}å¤©`:f.st==='broke'?'âœ— å¤±è´¥':'å¾…è®°å½•'}</span>
      <button onclick="event.stopPropagation();delF('${f.id}')" style="background:none;border:none;color:var(--text2);font-size:18px;cursor:pointer;padding:0 2px;flex-shrink:0">Ã—</button>
    </div>`).join('');
}
function allForbKept(){
  S.forb.forEach(f=>{if(f.st!=='broke'){f.st='kept';f.d=(f.d||0)+1;}});
  sv();rDaily();
}
function cycD(id){const t=S.daily.find(x=>x.id===id);if(!t)return;const c=['p','d','f'];t.st=c[(c.indexOf(t.st)+1)%3];if(t.st==='d')t.sk=(t.sk||0)+1;sv();rDaily();}
function delD(id){S.daily=S.daily.filter(x=>x.id!==id);sv();rDaily();}
function cycF(id){const f=S.forb.find(x=>x.id===id);if(!f)return;const c=['p','kept','broke'];f.st=c[(c.indexOf(f.st)+1)%3];if(f.st==='kept')f.d=(f.d||0)+1;sv();rDaily();}
function delF(id){S.forb=S.forb.filter(x=>x.id!==id);sv();rDaily();}

// â•â•â• TASKS â•â•â•
let tMain='all',tSub='today',showDone=false;
function toggleShowDone(){
  showDone=!showDone;
  const btn=document.getElementById('doneToggleBtn');
  if(btn){btn.textContent=showDone?'éšè—å·²å®Œæˆ':'æ˜¾ç¤ºå·²å®Œæˆ';btn.style.color=showDone?'var(--gr)':'var(--text2)';}
  rTaskList();
}
const TM=[{k:'all',l:'å…¨éƒ¨'},{k:'main',l:'ğŸš© ä¸»çº¿ä»»åŠ¡'},{k:'side',l:'ğŸ”¹ æ”¯çº¿ä»»åŠ¡'},{k:'over',l:'âš ï¸ é¡ºå»¶ä»»åŠ¡'}];
const TS=[{k:'today',l:'ä»Šæ—¥'},{k:'long',l:'é•¿æœŸ'},{k:'box',l:'ğŸ“¦ æ”¶é›†ç®±'}];
const TPMAP={'mt':'ä¸»çº¿ä»Šæ—¥','ml':'ä¸»çº¿é•¿æœŸ','st':'æ”¯çº¿ä»Šæ—¥','sl':'æ”¯çº¿é•¿æœŸ','bx':'æ”¶é›†ç®±','bm':'æ”¶é›†ç®±','bs':'æ”¶é›†ç®±','ov':'é¡ºå»¶'};
const TBCLS={'mt':'bm','ml':'bm','st':'bs','sl':'bs','bx':'bb','bm':'bb','bs':'bb','ov':'bo'};
function subCount(mainType, subType){
  if(mainType==='main'){
    if(subType==='today') return S.tasks.filter(t=>t.tp==='mt'&&!t.done).length;
    if(subType==='long')  return S.tasks.filter(t=>t.tp==='ml'&&!t.done).length;
    if(subType==='box')   return S.tasks.filter(t=>(t.tp==='bm'||t.tp==='bx')).length;
  }
  if(mainType==='side'){
    if(subType==='today') return S.tasks.filter(t=>t.tp==='st'&&!t.done).length;
    if(subType==='long')  return S.tasks.filter(t=>t.tp==='sl'&&!t.done).length;
    if(subType==='box')   return S.tasks.filter(t=>t.tp==='bs').length;
  }
  return 0;
}
function taskCount(type){
  if(type==='main')return S.tasks.filter(t=>(t.tp==='mt'||t.tp==='ml')&&!t.done).length;
  if(type==='side')return S.tasks.filter(t=>(t.tp==='st'||t.tp==='sl')&&!t.done).length;
  if(type==='over')return S.tasks.filter(t=>t.tp==='ov').length;
  return 0;
}
function rTasks(){
  document.getElementById('tmtabs').innerHTML=TM.map(t=>{
    const cnt=t.k!=='all'?taskCount(t.k):0;
    const badge=cnt>0?`<div class="badge">${cnt}</div>`:'';
    return`<button class="tmtab${tMain===t.k?' on':''}" onclick="setTM('${t.k}')">${t.l}${badge}</button>`;
  }).join('');
  const showSub=tMain==='main'||tMain==='side';
  document.getElementById('tstabs').innerHTML=showSub?TS.map(t=>{
    const cnt=subCount(tMain,t.k);
    const badge=cnt>0?`<div class="badge">${cnt}</div>`:'';
    return`<button class="tstab${tSub===t.k?' on':''}" onclick="setTS('${t.k}')">${t.l}${badge}</button>`;
  }).join(''):'';
  const ml=TM.find(t=>t.k===tMain)?.l||'å…¨éƒ¨';
  const sl=showSub?' Â· '+(TS.find(t=>t.k===tSub)?.l||''):'';
  document.getElementById('tlabel').textContent=ml+sl;
  let tasks=S.tasks;
  if(tMain==='over')tasks=S.tasks.filter(t=>t.tp==='ov');
  else if(tMain==='main'){
    if(tSub==='today')tasks=S.tasks.filter(t=>t.tp==='mt');
    else if(tSub==='long')tasks=S.tasks.filter(t=>t.tp==='ml');
    else tasks=S.tasks.filter(t=>t.tp==='bm'||t.tp==='bx');
  } else if(tMain==='side'){
    if(tSub==='today')tasks=S.tasks.filter(t=>t.tp==='st');
    else if(tSub==='long')tasks=S.tasks.filter(t=>t.tp==='sl');
    else tasks=S.tasks.filter(t=>t.tp==='bs');
  }
  rTaskList(tasks);
}
function rTaskList(tasks){
  if(!tasks){
    // Re-derive from current filter state
    tasks=S.tasks;
    if(tMain==='over')tasks=S.tasks.filter(t=>t.tp==='ov');
    else if(tMain==='main'){
      if(tSub==='today')tasks=S.tasks.filter(t=>t.tp==='mt');
      else if(tSub==='long')tasks=S.tasks.filter(t=>t.tp==='ml');
      else tasks=S.tasks.filter(t=>t.tp==='bm'||t.tp==='bx');
    } else if(tMain==='side'){
      if(tSub==='today')tasks=S.tasks.filter(t=>t.tp==='st');
      else if(tSub==='long')tasks=S.tasks.filter(t=>t.tp==='sl');
      else tasks=S.tasks.filter(t=>t.tp==='bs');
    }
  }
  const pending=tasks.filter(t=>!t.done&&t.tp!=='ov').sort((a,b)=>{const o={'mt':0,'st':1,'ml':2,'sl':3,'bx':4,'bm':4,'bs':4,'ov':5};return(o[a.tp]||0)-(o[b.tp]||0);});
  const overdues=tasks.filter(t=>t.tp==='ov');
  const done=tasks.filter(t=>t.done);
  const isBox=t=>t.tp==='bx'||t.tp==='bm'||t.tp==='bs';
  const TPMAP={'mt':'ä¸»çº¿ä»Šæ—¥','ml':'ä¸»çº¿é•¿æœŸ','st':'æ”¯çº¿ä»Šæ—¥','sl':'æ”¯çº¿é•¿æœŸ','bx':'æ”¶é›†ç®±','bm':'æ”¶é›†ç®±','bs':'æ”¶é›†ç®±','ov':'é¡ºå»¶'};
  const TBCLS={'mt':'bm','ml':'bm','st':'bs','sl':'bs','bx':'bb','bm':'bb','bs':'bb','ov':'bo'};
  function mkCard(t){
    return`<div class="tcard ${t.done?'done':''} ${t.tp==='ov'?'ov':''}" onclick="${!isBox(t)?`togT('${t.id}')`:''}" >
      <div class="ttop">
        ${isBox(t)?`<span style="font-size:16px;margin-top:2px;flex-shrink:0">ğŸ“¦</span>`:`<div class="tcb">${t.done?'âœ“':''}</div>`}
        <div class="ttit">${t.t}</div>
        <div class="tbadge ${TBCLS[t.tp]||'bb'}">${TPMAP[t.tp]||''}</div>
      </div>
      ${t.n?`<div class="tnote">${t.n}</div>`:''}
      <div class="tmeta">
        ${t.due?`<span class="tdue">æˆªæ­¢ ${t.due}</span>`:''}
        ${t.tp!=='ov'?`<button class="tbtn" style="color:var(--re)" onclick="event.stopPropagation();toOv('${t.id}')">â†’ é¡ºå»¶</button>`:`<button class="tbtn" style="color:var(--gr)" onclick="event.stopPropagation();fromOv('${t.id}')">â†© æ¢å¤</button>`}
        <button class="tbtn" style="color:var(--text2)" onclick="event.stopPropagation();delT('${t.id}')">Ã— åˆ é™¤</button>
      </div>
    </div>`;
  }
  const tl=document.getElementById('tlist');
  if(!pending.length&&!overdues.length&&!done.length){
    tl.innerHTML=`<div class="empty"><div class="ei">ğŸ“‹</div><p>æš‚æ— ä»»åŠ¡</p></div>`;return;
  }
  let html='';
  if(overdues.length){
    html+=`<div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--re);text-transform:uppercase;padding:6px 0 4px">âš ï¸ é¡ºå»¶ (${overdues.length})</div>`;
    html+=overdues.map(mkCard).join('');
  }
  if(pending.length){
    html+=overdues.length?`<div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--text2);text-transform:uppercase;padding:8px 0 4px">å¾…å®Œæˆ (${pending.length})</div>`:'';
    html+=pending.map(mkCard).join('');
  }
  if(showDone&&done.length){
    html+=`<div style="font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--gr);text-transform:uppercase;padding:8px 0 4px;margin-top:4px;border-top:1px solid var(--border)">âœ… å·²å®Œæˆ (${done.length})</div>`;
    html+=done.map(mkCard).join('');
  } else if(!showDone&&done.length){
    html+=`<div style="font-size:12px;color:var(--text2);text-align:center;padding:10px;cursor:pointer" onclick="toggleShowDone()">å·²å®Œæˆ ${done.length} é¡¹ï¼Œç‚¹å‡»æŸ¥çœ‹ â€º</div>`;
  }
  tl.innerHTML=html;
}
function setTM(k){tMain=k;tSub='today';rTasks();}
function setTS(k){tSub=k;rTasks();}
function togT(id){const t=S.tasks.find(x=>x.id===id);if(!t)return;t.done=!t.done;sv();rTasks();}
function delT(id){S.tasks=S.tasks.filter(x=>x.id!==id);sv();rTasks();}
function toOv(id){const t=S.tasks.find(x=>x.id===id);if(t){t.tp='ov';sv();rTasks();}}
function fromOv(id){const t=S.tasks.find(x=>x.id===id);if(t){t.tp='mt';sv();rTasks();}}

// â•â•â• STATS â•â•â•
function compTotal(){
  const tot={hp:0,str:0,int:0,agi:0,ap:0};
  Object.keys(S.grid).forEach(d=>{
    const a=compA(d);Object.keys(tot).forEach(k=>tot[k]+=a[k]);
  });
  Object.keys(tot).forEach(k=>tot[k]=Math.round(tot[k]*100)/100);
  return tot;
}
function rStats(){
  const tot=compTotal();
  const todayA=compA(tod());
  document.getElementById('sgrid').innerHTML=`
    <div style="grid-column:1/-1;padding:0 0 8px">
      <div style="font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text2);text-transform:uppercase;margin-bottom:10px">ç´¯è®¡æ€»å±æ€§</div>
      ${ATTRS.map(x=>`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div style="font-size:12px;font-weight:700;color:${x.c};min-width:46px">${x.l}</div>
        <div style="flex:1;height:14px;background:var(--bg3);border-radius:7px;overflow:hidden">
          <div style="height:100%;border-radius:7px;background:${x.c};width:${Math.min(100,tot[x.k]/Math.max(...ATTRS.map(a=>tot[a.k]),1)*100)}%;transition:width .4s"></div>
        </div>
        <div style="font-size:13px;font-weight:700;font-family:'Share Tech Mono',monospace;color:${x.c};min-width:48px;text-align:right">${tot[x.k].toFixed(2)}</div>
      </div>`).join('')}
    </div>
    <div style="grid-column:1/-1;border-top:1px solid var(--border);padding-top:10px;margin-bottom:2px">
      <div style="font-size:10px;font-weight:700;letter-spacing:2px;color:var(--text2);text-transform:uppercase;margin-bottom:8px">ä»Šæ—¥å±æ€§</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        ${ATTRS.map(x=>`<div style="background:var(--bg3);border-radius:8px;padding:6px 10px;display:flex;flex-direction:column;align-items:center;gap:2px">
          <span style="font-size:14px;font-weight:700;font-family:'Share Tech Mono',monospace;color:${x.c}">+${todayA[x.k].toFixed(2)}</span>
          <span style="font-size:9px;color:var(--text2);font-weight:700">${x.l}</span>
        </div>`).join('')}
      </div>
    </div>
  `;
  const dates=Object.keys(S.grid).sort().reverse().slice(0,14);
  const hl=document.getElementById('hlist');
  if(!dates.length){hl.innerHTML=`<div class="empty"><p>æš‚æ— å†å²è®°å½•</p></div>`;return;}
  hl.innerHTML=dates.map(d=>{
    const g=S.grid[d];const cts={};COLS.forEach(c=>cts[c.k]=0);
    g.forEach(c=>{if(c&&cts[c.c]!==undefined)cts[c.c]++;});
    const tot=Object.values(cts).reduce((a,b)=>a+b,0);
    const bar=COLS.filter(c=>cts[c.k]>0).map(c=>`<div class="hseg" style="flex:${cts[c.k]};background:${c.h}"></div>`).join('');
    const a2=compA(d);
    const chips=ATTRS.filter(x=>a2[x.k]>0).map(x=>`<div class="hchip" style="color:${x.c}">+${a2[x.k].toFixed(1)} ${x.l}</div>`).join('');
    return`<div class="hrow" onclick="S.gDate='${d}';go('time')">
      <div><div class="hdate">${d.slice(5)}</div>${d===tod()?`<div style="font-size:9px;color:var(--ye)">ä»Šå¤©</div>`:''}</div>
      <div style="flex:1"><div class="hbar">${bar||`<div style="flex:1;background:var(--bg3);height:100%"></div>`}</div><div class="hchips" style="margin-top:4px">${chips}</div></div>
    </div>`;
  }).join('');
}

// â•â•â• MODAL â•â•â•
function openM(type){
  document.getElementById('mbg').classList.add('show');
  if(type==='adDaily'){
    document.getElementById('mtit').textContent='æ·»åŠ æ¯æ—¥ä»»åŠ¡';
    document.getElementById('mbody').innerHTML=`
      <div class="fl"><label class="flab">å›¾æ ‡ï¼ˆemojiï¼‰</label><input class="fi" id="mIco" placeholder="ğŸ“Œ" maxlength="2"></div>
      <div class="fl"><label class="flab">ä»»åŠ¡åç§°</label><input class="fi" id="mNm" placeholder="ä¾‹ï¼šå†¥æƒ³"></div>
      <div class="fl"><label class="flab">è¦æ±‚ï¼ˆå¯é€‰ï¼‰</label><input class="fi" id="mRq" placeholder="ä¾‹ï¼šâ‰¥30åˆ†é’Ÿ"></div>
      <button class="fbtn" onclick="doAdD()">æ·»åŠ </button>`;
  } else if(type==='adForb'){
    document.getElementById('mtit').textContent='æ·»åŠ ç¦æ­¢äº‹é¡¹';
    document.getElementById('mbody').innerHTML=`
      <div class="fl"><label class="flab">å›¾æ ‡</label><input class="fi" id="mFIco" placeholder="ğŸš«" maxlength="2"></div>
      <div class="fl"><label class="flab">åç§°</label><input class="fi" id="mFNm" placeholder="ä¾‹ï¼šæˆ’æ‰‹æ¸¸"></div>
      <button class="fbtn" onclick="doAdF()">æ·»åŠ </button>`;
  } else if(type==='adTask'){
    document.getElementById('mtit').textContent='æ–°å¢ä»»åŠ¡';
    document.getElementById('mbody').innerHTML=`
      <div class="fl"><label class="flab">ä»»åŠ¡åç§°</label><input class="fi" id="mTN" placeholder="ä»»åŠ¡åç§°..."></div>
      <div class="fl"><label class="flab">ç±»å‹</label>
        <select class="fs" id="mTT">
          <option value="mt">ğŸš© ä¸»çº¿Â·ä»Šæ—¥</option>
          <option value="ml">ğŸš© ä¸»çº¿Â·é•¿æœŸ</option>
          <option value="st">ğŸ”¹ æ”¯çº¿Â·ä»Šæ—¥</option>
          <option value="sl">ğŸ”¹ æ”¯çº¿Â·é•¿æœŸ</option>
          <option value="bx">ğŸ“¦ æ”¶é›†ç®±</option>
        </select></div>
      <div class="fl"><label class="flab">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label><input class="fi" id="mTNo" placeholder="å¤‡æ³¨..."></div>
      <div class="fl"><label class="flab">æˆªæ­¢æ—¥æœŸï¼ˆå¯é€‰ï¼‰</label><input class="fi" type="date" id="mTDue"></div>
      <button class="fbtn" onclick="doAdT()">æ·»åŠ </button>`;
  }
}
function doAdD(){const n=document.getElementById('mNm').value.trim();if(!n)return;S.daily.push({id:'d'+Date.now(),n,ic:document.getElementById('mIco').value.trim()||'ğŸ“Œ',r:document.getElementById('mRq').value.trim(),st:'p',sk:0});sv();closeM();rDaily();}
function doAdF(){const n=document.getElementById('mFNm').value.trim();if(!n)return;S.forb.push({id:'f'+Date.now(),n,ic:document.getElementById('mFIco').value.trim()||'ğŸš«',st:'p',d:0});sv();closeM();rDaily();}
function doAdT(){const t=document.getElementById('mTN').value.trim();if(!t)return;S.tasks.push({id:'t'+Date.now(),t,tp:document.getElementById('mTT').value,n:document.getElementById('mTNo').value.trim(),due:document.getElementById('mTDue').value||null,done:false});sv();closeM();rTasks();}
function closeM(){document.getElementById('mbg').classList.remove('show');}
function bgC(e){if(e.target===document.getElementById('mbg'))closeM();}

// â•â•â• INIT â•â•â•
function init(){
  ld();
  if(!S.gDate)S.gDate=tod();
  rHdr();initAI();
  setInterval(rHdr,60000);
}
init();
</script>


</body></html>
